name: Flutter CI  # Nom du workflow, √ßa appara√Ætra dans l‚Äôonglet Actions

on:
  push:
    branches:
      - "**"     # Ex√©cute la CI sur TOUTES les branches quand tu push
  pull_request:
    branches:
      - main     # Ex√©cute aussi la CI sur les PR qui ciblent main

jobs:
  flutter-ci:
    name: Flutter CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # R√©cup√®re ton code dans la machine CI

      - name: Setup Flutter
        uses: subosito/flutter-action@v2  # Installe Flutter automatiquement
        with:
          channel: stable                # Utilise Flutter stable (le classique)

      - name: Flutter version
        run: flutter --version           # Juste pour afficher la version (log utile)

      - name: Get dependencies
        run: flutter pub get            # R√©cup√®re toutes les d√©pendances du projet

      - name: Analyze
        run: flutter analyze            # Analyse du code pour d√©tecter erreurs/bricoles

      # Pour un projet avec de la logique m√©tier
      # - name: Test
      #   run: flutter test               # Lance les tests unitaires (si t‚Äôen as, sinon √ßa passe direct)

      - name: Build Web (release)
        run: flutter build web --release  # V√©rifie que ton build Flutter Web compile bien

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4  # Enregistre le build final dans GitHub
        with:
          name: web-build                 # Nom de l‚Äôartefact
          path: build/web                 # Le dossier g√©n√©r√© par la commande build
          
 # -------------------------------------------------------------------
      #                 üöÄ NETLIFY DEPLOY (PRODUCTION)
      #   ‚û§ Ne s'ex√©cute QUE quand tu pushes sur main (propre et s√©curis√©)
      # -------------------------------------------------------------------

      - name: Install Netlify CLI
        if: github.ref == 'refs/heads/main'
        run: npm install -g netlify-cli

      - name: Deploy to Netlify (production)
        if: github.ref == 'refs/heads/main'
        run: netlify deploy --prod --dir build/web --site $NETLIFY_SITE_ID
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}